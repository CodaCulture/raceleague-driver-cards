<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Driver Rating Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --bg1:#111;
  --bg2:#000;
  --accent:#fff;
  --stat:#fff;
}

body{
  margin:0;
  background:#0b0b10;
  font-family:Arial,sans-serif;
  color:#fff;
  display:flex;
  justify-content:center;
  padding:24px;
}

.panel{width:480px;display:grid;gap:14px}

/* CONTROLS */
.toolbar{
  background:rgba(0,0,0,.45);
  border-radius:18px;
  padding:16px;
  display:grid;
  gap:10px;
}
.toolbar select,
.toolbar input,
.toolbar textarea,
.toolbar button{
  padding:12px;
  border-radius:12px;
  border:none;
  font-weight:700;
  font-family:inherit;
}
.toolbar textarea{
  background:#111;
  color:#fff;
  resize:vertical;
  min-height:140px;
}
.toolbar select,
.toolbar input{
  background:#111;
  color:#fff;
}
.toolbar button{
  background:#3a5cff;
  color:#fff;
  cursor:pointer;
}

/* CARD */
.card{
  position:relative;
  border-radius:30px;
  padding:24px;
  overflow:hidden;
  box-shadow:0 40px 90px rgba(0,0,0,.75);
}
.card::before{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  z-index:-3;
}
.card::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(60deg,rgba(255,255,255,.04) 1px,transparent 1px);
  background-size:28px 28px;
  opacity:.45;
  z-index:-2;
}

.accent{
  position:absolute;
  left:0;top:0;bottom:0;
  width:8px;
  background:var(--accent);
  box-shadow:0 0 18px var(--accent);
}

/* TEAM LOGO (REAL IMG, EXPORT SAFE) */
.team-bg{
  position:absolute;
  left:50%;
  top:50%;
  width:150%;
  height:150%;
  transform:translate(-50%,-50%);
  object-fit:contain;
  opacity:.09;
  filter:blur(2px);
  z-index:-1;
  pointer-events:none;
}

/* HEADER */
.top{display:grid;justify-items:center;gap:14px}
.avatar{
  width:120px;height:120px;
  border-radius:22px;
  object-fit:cover;
  background:#000;
}
.name{
  font-size:22px;
  font-weight:900;
  letter-spacing:1px;
  text-transform:uppercase;
}

/* AVERAGE */
.avg{
  font-size:64px;
  font-weight:900;
  text-align:center;
  margin-top:8px;
}
.avg-sub{text-align:center;opacity:.7;font-size:12px}

/* STATS */
.stats{
  margin-top:18px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.stat{
  background:rgba(0,0,0,.55);
  border-radius:16px;
  padding:12px;
  display:grid;
  gap:6px;
}
.stat label{font-size:12px;opacity:.7;font-weight:800}
.value{
  padding:10px;
  border-radius:12px;
  background:var(--stat);
  color:#000;
  font-size:24px;
  font-weight:900;
  text-align:center;
}

.export{
  padding:14px;
  border-radius:14px;
  border:none;
  background:#3a5cff;
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
</style>
</head>

<body>
<div class="panel">

  <div class="toolbar">
    <select id="team">
      <option value="mps">MPS Racing Team</option>
    </select>

    <input id="driverNameInput" placeholder="Driver Name">

    <label>Driver Avatar (PNG)</label>
    <input type="file" id="avatarUpload" accept="image/png">

    <label>Paste Ratings</label>
    <textarea id="ratingsInput"></textarea>

    <button onclick="applyAll()">Apply</button>
  </div>

  <div class="card" id="card">
    <div class="accent"></div>
    <img id="teamBg" class="team-bg" crossorigin="anonymous">
    <div class="top">
      <img id="avatar" class="avatar" crossorigin="anonymous">
      <div class="name" id="driverName">DRIVER</div>
    </div>

    <div class="avg" id="average">0.00</div>
    <div class="avg-sub">Average Rating</div>
    <div class="stats" id="stats"></div>
  </div>

  <button class="export" onclick="exportPNG()">Export PNG</button>
</div>

<script>
const teams={
  mps:{
    bg1:"#C40000",
    bg2:"#400000",
    accent:"#C40000",
    stat:"#E0E0E0",
    logo:"assets/logos/MPS.png"
  }
};

function round25(v){return Math.round(v*4)/4}

function parseRatings(text){
  return text.split("\n").map(l=>{
    const m=l.match(/-?\s*([^0-9]+)\s*([\d.]+)\s*\/10/i);
    return m?{name:m[1].trim(),value:round25(+m[2])}:null;
  }).filter(Boolean);
}

async function decodeImages(el){
  const imgs=[...el.querySelectorAll("img")];
  for(const img of imgs){
    if(!img.src) continue;
    if(img.decode){
      try{await img.decode()}catch{}
    }else{
      await new Promise(r=>img.onload=img.onerror=r);
    }
  }
}

function applyAll(){
  const t=teams.mps;
  const card=document.getElementById("card");

  card.style.setProperty("--bg1",t.bg1);
  card.style.setProperty("--bg2",t.bg2);
  card.style.setProperty("--accent",t.accent);
  card.style.setProperty("--stat",t.stat);

  document.getElementById("teamBg").src=t.logo;
  document.getElementById("driverName").textContent =
    document.getElementById("driverNameInput").value.toUpperCase();

  const stats=parseRatings(document.getElementById("ratingsInput").value);
  const statsEl=document.getElementById("stats");
  statsEl.innerHTML="";
  let sum=0,count=0;

  stats.forEach(s=>{
    statsEl.insertAdjacentHTML(
      "beforeend",
      `<div class="stat"><label>${s.name}</label><div class="value">${s.value.toFixed(2)}</div></div>`
    );
    if(!["Penalties","Lag"].includes(s.name)){sum+=s.value;count++}
  });

  document.getElementById("average").textContent =
    (count?round25(sum/count):0).toFixed(2);

  const f=document.getElementById("avatarUpload");
  if(f.files.length){
    const r=new FileReader();
    r.onload=e=>document.getElementById("avatar").src=e.target.result;
    r.readAsDataURL(f.files[0]);
  }
}

async function exportPNG(){
  const card=document.getElementById("card");
  await decodeImages(card);

  const canvas=await html2canvas(card,{
    scale:2,
    useCORS:true,
    backgroundColor:null
  });

  const a=document.createElement("a");
  a.href=canvas.toDataURL("image/png");
  a.download="driver_card.png";
  a.click();
}
</script>
</body>
</html>
