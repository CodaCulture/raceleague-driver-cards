<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Driver Card Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{
  margin:0;
  background:#0b0b10;
  font-family:Arial,sans-serif;
  color:#fff;
  display:flex;
  justify-content:center;
  padding:24px;
}

.hidden{display:none}

.panel{width:500px;display:grid;gap:16px}

/* ---------- BUILDER ---------- */
.builder{
  background:rgba(0,0,0,.5);
  border-radius:20px;
  padding:16px;
  display:grid;
  gap:10px;
}

input, select, textarea, button{
  padding:12px;
  border-radius:12px;
  border:none;
  background:#111;
  color:#fff;
  font-weight:700;
}

textarea{
  resize:vertical;
  min-height:130px;
}

button{
  background:#3a5cff;
  cursor:pointer;
}

/* ---------- CARD (RENDER SOURCE) ---------- */
.card{
  position:relative;
  width:480px;
  border-radius:28px;
  padding:24px;
  overflow:hidden;
}

.card::before{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  z-index:-2;
}

.logo-bg{
  position:absolute;
  inset:0;
  background-repeat:no-repeat;
  background-position:center;
  background-size:70%;
  opacity:.08;
  z-index:-1;
}

.avatar{
  width:120px;
  height:120px;
  border-radius:22px;
  background:#000;
  margin:0 auto 10px;
}

.name{
  text-align:center;
  font-size:22px;
  font-weight:900;
}

.avg{
  text-align:center;
  font-size:64px;
  font-weight:900;
  margin:8px 0;
}

.stats{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

.stat{
  background:rgba(0,0,0,.55);
  border-radius:14px;
  padding:10px;
}

.stat label{
  font-size:12px;
  opacity:.7;
}

.value{
  background:var(--stat);
  color:#000;
  font-weight:900;
  text-align:center;
  padding:8px;
  border-radius:10px;
  font-size:20px;
}

/* ---------- EXPORT PAGE ---------- */
.export{
  background:rgba(0,0,0,.5);
  border-radius:20px;
  padding:16px;
  display:grid;
  gap:12px;
}

.preview{
  width:100%;
  border-radius:20px;
  display:block;
}

</style>
</head>

<body>
<div class="panel">

<!-- BUILDER -->
<div class="builder" id="builder">
  <select id="team">
    <option value="vassetti">Vassetti Corse</option>
    <option value="vassetti_enduro">Vassetti Enduro</option>
    <option value="mps">MPS Racing Team</option>
    <option value="lotus">Lotus GP</option>
    <option value="nc">NC Corse</option>
    <option value="aierra">Aierra Racing</option>
    <option value="stuttgart">Stuttgart</option>
    <option value="redboars">Red Boars Racing</option>
    <option value="hive">CS Hive Racing</option>
    <option value="mismo">Mismo LTS Racing</option>
    <option value="atlas">Atlas GP</option>
  </select>

  <input id="driverName" placeholder="Driver Name">

  <input type="file" id="avatarInput" accept="image/png">

  <textarea id="ratingsInput" placeholder="-Attacking 6/10"></textarea>

  <button onclick="generate()">Generate Card</button>
</div>

<!-- HIDDEN RENDER CARD -->
<div class="card hidden" id="card"></div>

<!-- EXPORT -->
<div class="export hidden" id="export">
  <input id="filename" value="driver_card.png">
  <img id="preview" class="preview">
  <button onclick="saveImage()">Save Image</button>
</div>

</div>

<script>
const teams={
  vassetti:{bg1:"#F2C300",bg2:"#0B0B0B",stat:"#F2C300",logo:"assets/logos/vassetti.png"},
  vassetti_enduro:{bg1:"#0B0B0B",bg2:"#000",stat:"#F2C300",logo:"assets/logos/vassetti_enduro.png"},
  mps:{bg1:"#C40000",bg2:"#400000",stat:"#E0E0E0",logo:"assets/logos/MPS.png"},
  lotus:{bg1:"#B89B3C",bg2:"#0B0B0B",stat:"#B89B3C",logo:"assets/logos/lotus.png"},
  nc:{bg1:"#C40000",bg2:"#0B0B0B",stat:"#FFD200",logo:"assets/logos/nc.png"},
  aierra:{bg1:"#FFFFFF",bg2:"#111",stat:"#FF4FA3",logo:"assets/logos/aierra.png"},
  stuttgart:{bg1:"#CFCFCF",bg2:"#0A3A6A",stat:"#CFCFCF",logo:"assets/logos/stuttgart.png"},
  redboars:{bg1:"#0B1530",bg2:"#C40000",stat:"#C40000",logo:"assets/logos/redboars.png"},
  hive:{bg1:"#0F1F3A",bg2:"#000814",stat:"#C8A100",logo:"assets/logos/hive.png"},
  mismo:{bg1:"#0B2A1A",bg2:"#102015",stat:"#FF7A18",logo:"assets/logos/mismo.png"},
  atlas:{bg1:"#7FD3FF",bg2:"#FFFFFF",stat:"#7FD3FF",logo:"assets/logos/atlas.png"}
};

function round25(v){return Math.round(v*4)/4}

function parseRatings(txt){
  return txt.split("\n").map(l=>{
    const m=l.match(/-?\s*([^0-9]+)\s*([\d.]+)/);
    return m?{name:m[1].trim(),value:round25(+m[2])}:null;
  }).filter(Boolean);
}

async function generate(){
  const team=teams[document.getElementById("team").value];
  const name=document.getElementById("driverName").value.toUpperCase();
  const ratings=parseRatings(document.getElementById("ratingsInput").value);

  const card=document.getElementById("card");
  card.innerHTML="";
  card.style.setProperty("--bg1",team.bg1);
  card.style.setProperty("--bg2",team.bg2);
  card.style.setProperty("--stat",team.stat);

  card.innerHTML=`
    <div class="logo-bg" style="background-image:url('${team.logo}')"></div>
    <div class="avatar"></div>
    <div class="name">${name}</div>
    <div class="avg">${calcAvg(ratings).toFixed(2)}</div>
    <div class="stats">
      ${ratings.map(r=>`
        <div class="stat">
          <label>${r.name}</label>
          <div class="value">${r.value.toFixed(2)}</div>
        </div>`).join("")}
    </div>
  `;

  const file=document.getElementById("avatarInput").files[0];
  if(file){
    const img=URL.createObjectURL(file);
    card.querySelector(".avatar").style.backgroundImage=`url(${img})`;
    card.querySelector(".avatar").style.backgroundSize="cover";
  }

  const canvas=await html2canvas(card,{scale:2,useCORS:true});
  const img=canvas.toDataURL("image/png");

  document.getElementById("preview").src=img;
  document.getElementById("builder").classList.add("hidden");
  document.getElementById("export").classList.remove("hidden");
}

function calcAvg(r){
  const valid=r.filter(s=>!["Penalties","Lag"].includes(s.name));
  return valid.reduce((a,b)=>a+b.value,0)/valid.length||0;
}

function saveImage(){
  const a=document.createElement("a");
  a.href=document.getElementById("preview").src;
  a.download=document.getElementById("filename").value||"driver_card.png";
  a.click();
}
</script>
</body>
</html>

