<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Driver Card Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  background:#0b0b10;
  font-family:Arial,sans-serif;
  color:#fff;
  display:flex;
  justify-content:center;
  padding:24px;
}
.panel{width:520px;display:grid;gap:16px}
input,select,textarea,button{
  padding:12px;
  border-radius:12px;
  border:none;
  background:#111;
  color:#fff;
  font-weight:700;
}
textarea{min-height:130px;resize:vertical}
button{background:#3a5cff;cursor:pointer}
.preview{
  width:100%;
  border-radius:20px;
  background:#000;
}
</style>
</head>

<body>
<div class="panel">

  <select id="teamSelect">
    <option value="vassetti">Vassetti Corse</option>
    <option value="vassetti_enduro">Vassetti Enduro</option>
    <option value="mps">MPS Racing Team</option>
    <option value="lotus">Lotus GP</option>
    <option value="nc">NC Corse</option>
    <option value="aierra">Aierra Racing</option>
    <option value="stuttgart">Stuttgart</option>
    <option value="redboars">Red Boars Racing</option>
    <option value="hive">CS Hive Racing</option>
    <option value="mismo">Mismo LTS Racing</option>
    <option value="atlas">Atlas GP</option>
  </select>

  <input id="driverName" placeholder="Driver Name">
  <input type="file" id="avatarInput" accept="image/png">
  <textarea id="ratingsInput" placeholder="-Attacking 6/10"></textarea>

  <button onclick="generate()">Generate Card</button>

  <input id="filename" value="driver_card.png">
  <img id="preview" class="preview">
  <button onclick="saveImage()">Save Image</button>

</div>

<canvas id="canvas" width="960" height="1200" hidden></canvas>

<script>
const teams={
  vassetti:{c1:"#F2C300",c2:"#0B0B0B",logo:"assets/logos/vassetti.png"},
  vassetti_enduro:{c1:"#0B0B0B",c2:"#000",logo:"assets/logos/vassetti_enduro.png"},
  mps:{c1:"#C40000",c2:"#400000",logo:"assets/logos/mps.png"},
  lotus:{c1:"#B89B3C",c2:"#0B0B0B",logo:"assets/logos/lotus.png"},
  nc:{c1:"#C40000",c2:"#0B0B0B",logo:"assets/logos/nc.png"},
  aierra:{c1:"#FFFFFF",c2:"#222",logo:"assets/logos/aierra.png"},
  stuttgart:{c1:"#CFCFCF",c2:"#0A3A6A",logo:"assets/logos/stuttgart.png"},
  redboars:{c1:"#0B1530",c2:"#C40000",logo:"assets/logos/redboars.png"},
  hive:{c1:"#0F1F3A",c2:"#000814",logo:"assets/logos/hive.png"},
  mismo:{c1:"#0B2A1A",c2:"#102015",logo:"assets/logos/mismo.png"},
  atlas:{c1:"#7FD3FF",c2:"#FFFFFF",logo:"assets/logos/atlas.png"}
};

function parseRatings(text){
  return text.split("\n").map(l=>{
    const m=l.match(/-?\s*([^0-9]+)\s*([\d.]+)/);
    return m?{name:m[1].trim(),value:+m[2]}:null;
  }).filter(Boolean);
}

function generate(){
  const teamKey = document.getElementById("teamSelect").value;
  const teamData = teams[teamKey];
  const name = document.getElementById("driverName").value.toUpperCase();
  const ratings = parseRatings(document.getElementById("ratingsInput").value);

  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  // Background
  const grad = ctx.createLinearGradient(0,0,960,1200);
  grad.addColorStop(0,teamData.c1);
  grad.addColorStop(1,teamData.c2);
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,960,1200);

  // Logo watermark
  const logo = new Image();
  logo.onload = () => {
    ctx.globalAlpha = 0.08;
    ctx.drawImage(logo,180,300,600,600);
    ctx.globalAlpha = 1;
    drawContent();
  };
  logo.src = teamData.logo;

  function drawContent(){
    ctx.fillStyle="#fff";
    ctx.textAlign="center";

    ctx.font="900 48px Arial";
    ctx.fillText(name,480,80);

    const valid = ratings.filter(r=>!["Penalties","Lag"].includes(r.name));
    const avg = valid.reduce((a,b)=>a+b.value,0)/(valid.length||1);

    ctx.font="900 120px Arial";
    ctx.fillText(avg.toFixed(2),480,220);

    ctx.font="16px Arial";
    ctx.fillText("Average Rating",480,260);

    ctx.font="700 28px Arial";
    ctx.textAlign="left";
    let x=80,y=330;

    ratings.forEach((r,i)=>{
      ctx.fillText(`${r.name}: ${r.value.toFixed(2)}`,x,y);
      y+=48;
      if(i===4){x=500;y=330;}
    });

    if(document.getElementById("avatarInput").files[0]){
      const a = new Image();
      a.onload=()=>{
        ctx.drawImage(a,380,850,200,200);
        finish();
      };
      a.src = URL.createObjectURL(document.getElementById("avatarInput").files[0]);
    } else finish();
  }

  function finish(){
    document.getElementById("preview").src = canvas.toDataURL("image/png");
  }
}

function saveImage(){
  const a=document.createElement("a");
  a.href=document.getElementById("preview").src;
  a.download=document.getElementById("filename").value||"driver_card.png";
  a.click();
}
</script>
</body>
</html>
